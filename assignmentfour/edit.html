<!DOCTYPE html>
<html lang='en'>

<head>
    <meta http-equiv='content-type' content='text/html; charset=UTF-8'>
    <meta name='description' content='bullion management site, rare coins, gold, silver, platinum'>
    <meta name='author' content='CSE134B Dream Team'>
    <link rel='stylesheet' type='text/css' href='./style/style.css'>
    <meta name=viewport content='width=device-width, initial-scale=.8, minimum-scale = .8, user-scalable=yes'>
    <link rel='icon' href='favicon.ico' type='image/x-icon' />
    <link rel='shortcut icon' href='favicon.ico' type='image/x-icon' />
    <script src='./js/combine.js'></script>
    <script type='text/javascript' src='http://www.parsecdn.com/js/parse-1.4.2.min.js'></script>
    <title>New Item - CoinFlip</title>
</head>

<body>
    <script type='text/javascript'>
    initParse();
    loadTopNav();
    loadSideNav(1);
    </script>
    <section class='main-section'>
        <section class='coin_wrapper'>
            <div class='mobile-nav'>
                <a onclick='cancel();'>
                    <svg class='icon icon-keyboard-arrow-left'>
                        <symbol id='icon-keyboard-arrow-left' viewBox='0 0 1024 1024'>
                            <title>keyboard-arrow-left</title>
                            <path class='path1' d='M657.707 696.96l-195.627-195.627 195.627-195.627-60.373-60.373-256 256 256 256z'></path>
                        </symbol>
                        <use xlink:href='#icon-keyboard-arrow-left'></use>
                    </svg>
                </a>
                <span class='command-header'>Add Item</span>
            </div>
            <div class='coin_main'>
                <a onclick='cancel();'>
                    <div class='breadcrumb'>
                        <svg class='icon icon-play-arrow-rev'>
                            <symbol id='icon-play-arrow' viewBox='0 0 1024 1024'>
                                <title>play-arrow</title>
                                <path class='path1' d='M682.667 213.333v597.333l-469.333-298.667z'></path>
                            </symbol>
                            <use xlink:href='#icon-play-arrow'></use>
                        </svg>
                        <span class='command-header'>Add Item</span>
                    </div>
                </a>
                <section class='coin_image coin_detail'>
                    <div class='img_box'>
                        <div class='img_circle'></div>
                    </div>
                    <input id='picture' type='file' name='picture'/>
                </section>
                <section class='coin_detail'>
                    <table>
                        <tr>
                            <td>Medium</td>
                            <td>
                                <select id='medium-type'>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Metal</td>
                            <td>
                                <select id='metal-type'>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Type</td>
                            <td>
                                <input id='type-name' type='text' list='known-types' name='purchaseDate' />
                            </td>
                        </tr>
                        <tr>
                            <td>Purchase Date</td>
                            <td>
                                <input id='purchase-date' name='purchaseDate' />
                            </td>
                        </tr>
                        <tr>
                            <td>Qty.</td>
                            <td>
                                <input id='qty' name='qty' />
                            </td>
                        </tr>
                        <tr>
                            <td>Unit Price</td>
                            <td>
                                <input id='unit-price' name='unitPrice' />
                            </td>
                        </tr>
                        <tr>
                            <td>Metal %</td>
                            <td><input id='fineness' name='fineness'/></td>
                        </tr>
                        <tr>
                            <td>Weight/unit (g)</td>
                            <td><input id='wpu' list='denominations' name='wpu'/></td>
                        </tr>
                        <tr>
                            <td>Metal g/u</td>
                            <td><span id='mgpu'></span></td>
                        </tr>
                        <tr>
                            <td>Metal ozt/u</td>
                            <td><span id='mopu'></span></td>
                        </tr>
                        <tr>
                            <td>Total Metal (ozt)</td>
                            <td><span id='total-metal'></span></td>
                        </tr>
                        <tr>
                            <td>Premium</td>
                            <td><span id='premium'></span></td>
                        </tr>
                        <tr>
                            <td><strong>TOTAL</strong></td>
                            <td><span id='total-cost'></span></td>
                        </tr>
                    </table>
                    <a onclick='submitItem()'><span id='save'>Save to My Stack</span></a>
                    <a onclick='removeItem()'><span id='delete' class='hidden'>Delete from My Stack</span></a>
                    <a onclick='cancel();'><span id='cancel'>Cancel</span></a>
                </section>
            </div>
        </section>
    </section>
    <datalist id='known-types'>
    </datalist>
    <datalist id='denominations'>
    </datalist>
    <script type='text/javascript'>
    loadFooter();

    /* Globals */
    var g2ozt = 0.032151;

    var currentEditItem = null;
    var currentItemList = [];

    var mediumType;
    var metalType;
    var typeName;
    var purchaseDate;
    var qty;
    var unitPrice;
    var fineness;
    var wpu;
    var picture;

    var knownTypes;
    var denominations;
    
    /* Hooks */
    function cancel() {
      var metalType = metalInHash()
      if (metalType >= 0) {
        window.location.href = "metal-main.html#metal=" + metalToString(metalType);
      } else {
        window.location.href = "main.html";
      }
    }

    function submitItem() {
      var currentUser = Parse.User.current();
      if (!currentUser) {
        alert("Must be logged in!");
        return;
      }
      var fitype = parseInt(mediumType.val());
      var fmtype = parseInt(metalType.val());
      var fname = typeName.val();
      var fpurchaseDate = new Date(purchaseDate.val());
      var fqty = parseFloat(qty.val());
      var funitPrice = parseFloat(unitPrice.val());
      var ffineness = parseFloat(fineness.val());
      var fwpu = parseFloat(wpu.val());
      var fpicture;
      if (picture[0].files.length >= 0) {
        var file = picture[0].files[0];
        fpicture = new Parse.File(file.name, file);
      }
      if (currentEditItem) {
        updateItem(
            currentEditItem,
            fitype,
            fmtype,
            fname,
            fpurchaseDate,
            fqty,
            funitPrice,
            ffineness,
            fwpu,
            fpicture,
            function(item) {
              alert("Item updated");
            },
            function(item, error) {
              alert(error.message)
            });
      } else {
        createItem(
            fitype,
            fmtype,
            fname,
            fpurchaseDate,
            fqty,
            funitPrice,
            ffineness,
            fwpu,
            fpicture,
            function(item) {
              alert("Item created");
            },
            function(item, error) {
              alert(error.message)
            });
      }
    }

    function removeItem() {
      if (currentEditItem) {
        knownTypes = $("#known-types");
        deleteItem(currentEditItem, 
            function (item) {
              alert("Item deleted"); },
            function (item, error) {
              alert(error.message)
            });
      }
    }


    /* Updates */
    function updateTypeFilter() {
      currentItemList = getKnownItems(mediumType.val(), metalType.val());
      var typeOptions = "";
      for (var i = 0; i < currentItemList.length; i++) {
        typeOptions += "<option>" + currentItemList[i].name + "</option>";
      }
      knownTypes.html(typeOptions);
    }

    function updateAutocomplete() {
      for (var i = 0; i < currentItemList.length; i++) {
        var item = currentItemList[i];
        if (item.name == typeName.val()) {
          if (item.wpu) {
            wpu.val(item.wpu);
          }
          if (item.fineness) {
            fineness.val(item.fineness);
          }
          if (item.denominations) {
            var denomOptions = "";
            for (var i = 0; i < item.denominations.length; i++) {
              denomOptions += "<option>" + numberNicify(item.denominations[i] / g2ozt) + "</option>";
            }
            denominations.html(denomOptions);
            if (!wpu.val() && item.denominations.length > 0) {
              wpu.val(numberNicify(item.denominations[0] / g2ozt));
            }
          }
        }
      }
    }

    function updateCalculatables() {
      var qtyVal = parseInt(qty.val());
      if (isNaN(qtyVal)) {
        qtyVal = 0;
      }
      var finenessVal = parseFloat(fineness.val());
      if (isNaN(finenessVal)) {
        finenessVal = 0;
      }
      var unitPriceVal = parseFloat(unitPrice.val());
      if (isNaN(unitPriceVal)) {
        unitPriceVal = 0;
      }
      var wpuVal = parseFloat(wpu.val());
      if (isNaN(wpuVal)) {
        wpuVal = 0;
      }
      var mcpo = 0;
      if (metalType.val() == MetalType.GOLD)
        mcpo = getGoldPrice();
      if (metalType.val() == MetalType.SILVER)
        mcpo = getSilverPrice();
      if (metalType.val() == MetalType.PLATINUM)
        mcpo = getPlatinumPrice();
      $("#mgpu").text(numberNicify(finenessVal * wpuVal));
      $("#mopu").text(numberNicify(finenessVal * wpuVal * g2ozt));
      $("#total-metal").text(numberNicify(qtyVal * finenessVal * wpuVal * g2ozt));
      $("#premium").text(numberPricify(qtyVal * (unitPriceVal - mcpo * finenessVal * wpuVal * g2ozt)));
      $("#total-cost").text(numberPricify(unitPriceVal * qtyVal));
    }

    /* Loaders */
    function loadHandlers() {
      mediumType.change(updateTypeFilter);
      metalType.change(updateTypeFilter);
      qty.focusout(function() {
        updateCalculatables();
      });
      unitPrice.focusout(function() {
        updateCalculatables();
      });
      fineness.focusout(function() {
        updateCalculatables();
      });
      wpu.focusout(function() {
        updateCalculatables();
      });
      typeName.focusout(function() {
        updateAutocomplete();
        updateCalculatables();
      });
      picture.change(function(e) {
        var files = picture[0].files;
        if (FileReader && files && files.length) {
          var fr = new FileReader();
          fr.onload = function () {
            var newImg = "<img src='" + fr.result +  "' alt='' />";
            $(".img_box").html(newImg);
          };
          fr.readAsDataURL(files[0]);
        }
      });
    }

    /* Initializers */
    function baseInit() {
      mediumType = $("#medium-type");
      metalType = $("#metal-type");
      typeName = $("#type-name");
      purchaseDate = $("#purchase-date");
      qty = $("#qty");
      unitPrice = $("#unit-price");
      fineness = $("#fineness");
      wpu = $("#wpu");
      picture = $("#picture");
      knownTypes = $("#known-types");
      denominations = $("#denominations");
      var mediumOptions = 
        "<option value='" + ItemType.COIN + "'>Coin</option>" + 
        "<option value='" + ItemType.BAR  + "'>Bar</option>";
      mediumType.html(mediumOptions);
      var metalOptions = 
        "<option value='" + MetalType.GOLD      + "'>Gold</option>" + 
        "<option value='" + MetalType.SILVER    + "'>Silver</option>" +
        "<option value='" + MetalType.PLATINUM  + "'>Platinum</option>";
      metalType.html(metalOptions);
      var id = idInHash();
      if (id) {
        $("#delete").removeClass("hidden");
        $(".command-header").text("Edit Item");
        readItem(id, 
            function (item) {
              currentEditItem = item;
              mediumType.children()[currentEditItem.get("itype")].selected = true;
              metalType.children()[currentEditItem.get("mtype")].selected = true;
              updateTypeFilter();
              typeName.val(currentEditItem.get("name"));
              purchaseDate.val(dateNicify(currentEditItem.get("purchaseDate"))); 
              qty.val(currentEditItem.get("qty")); 
              unitPrice.val(currentEditItem.get("unitPrice")); 
              fineness.val(currentEditItem.get("fineness")); 
              wpu.val(currentEditItem.get("wpu")); 
              var mpicture = currentEditItem.get("picture");
              if (mpicture) {
                var newImg = "<img src='" + mpicture.url() +  "' alt='' />";
                $(".img_box").html(newImg);
              }
              loadHandlers();
              updateCalculatables();
            },
            function (item, error) {
              alert(error.message);
            });
      } else {
        var theDate = new Date();
        var metal = metalInHash();
        if (metal >= 0) {
            metalType.children()[metal].selected = true;
        }
        purchaseDate.val(dateNicify(theDate));
        loadHandlers();
        updateTypeFilter();
        updateCalculatables();
      }
    }
    $(document).ready(baseInit);
    </script>
</body>

</html>
